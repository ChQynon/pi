from http.server import BaseHTTPRequestHandler
import json
import os
import requests

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.environ.get('BOT_TOKEN', '8050987714:AAGEeXCsCVqXrLQjrypQDMys49UWPgpf0NE')
TELEGRAM_API = f"https://api.telegram.org/bot{BOT_TOKEN}"

class handler(BaseHTTPRequestHandler):
    def do_GET(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ GET-–∑–∞–ø—Ä–æ—Å–æ–≤"""
        self.send_response(200)
        self.send_header('Content-type', 'text/html; charset=utf-8')
        self.end_headers()
        self.wfile.write("–ë–æ—Ç –¥–ª—è —É—Ö–æ–¥–∞ –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!".encode('utf-8'))
    
    def do_POST(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook-–∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç Telegram"""
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã Telegram –Ω–µ –∂–¥–∞–ª
        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.end_headers()
        self.wfile.write(json.dumps({"ok": True}).encode('utf-8'))
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram
        try:
            update = json.loads(post_data.decode('utf-8'))
            process_update(update)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {e}")
            

def process_update(update):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç Telegram"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
    if 'message' in update:
        message = update['message']
        chat_id = message['chat']['id']
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
        if 'text' in message:
            text = message['text']
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
            if text.startswith('/'):
                process_command(chat_id, text)
            else:
                # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                send_message(chat_id, f"–í—ã –Ω–∞–ø–∏—Å–∞–ª–∏: {text}\n\n–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å —É—Ö–æ–¥–æ–º –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.")
                
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (callback_query –∏ —Ç.–¥.)


def process_command(chat_id, command):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞"""
    command = command.lower()
    
    if command.startswith('/start'):
        text = """üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —É—Ö–æ–¥–∞ –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏.

üå± –Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å:
‚Ä¢ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º —Ä–∞—Å—Ç–µ–Ω–∏–π –ø–æ —Ñ–æ—Ç–æ
‚Ä¢ –°–æ–≤–µ—Ç–∞–º–∏ –ø–æ —É—Ö–æ–¥—É –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–∏—Ç–∞–º–∏–Ω–∞—Ö
‚Ä¢ –°–æ–≤–µ—Ç–∞–º–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±—ã—Ç–æ–≤—ã—Ö –æ—Ç—Ö–æ–¥–æ–≤ –¥–ª—è —É–¥–æ–±—Ä–µ–Ω–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥."""
        send_message(chat_id, text)
        
    elif command.startswith('/help'):
        text = """üåø *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*

/start - –ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –±–æ—Ç–æ–º
/help - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
/care [–Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è] - –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —É—Ö–æ–¥—É –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏–µ–º

üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏—è, —á—Ç–æ–±—ã —è –µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª.

üå± –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã care:
/care –ú–æ–Ω—Å—Ç–µ—Ä–∞"""
        send_message(chat_id, text, parse_mode="Markdown")
        
    elif command.startswith('/care'):
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è –∏–∑ –∫–æ–º–∞–Ω–¥—ã
        parts = command.split(' ', 1)
        if len(parts) > 1:
            plant_name = parts[1].strip()
            send_care_tips(chat_id, plant_name)
        else:
            send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã. –ù–∞–ø—Ä–∏–º–µ—Ä: /care –ú–æ–Ω—Å—Ç–µ—Ä–∞")
    
    else:
        send_message(chat_id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.")


def send_care_tips(chat_id, plant_name):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–≤–µ—Ç—ã –ø–æ —É—Ö–æ–¥—É –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏–µ–º"""
    # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å—Ç–µ–Ω–∏–∏
    # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é –∑–∞–≥–ª—É—à–∫—É
    
    plants = {
        "–º–æ–Ω—Å—Ç–µ—Ä–∞": {
            "name": "–ú–æ–Ω—Å—Ç–µ—Ä–∞",
            "watering": "–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é, –¥–∞–≤–∞—è –ø–æ—á–≤–µ –ø–æ–¥—Å–æ—Ö–Ω—É—Ç—å –º–µ–∂–¥—É –ø–æ–ª–∏–≤–∞–º–∏",
            "light": "–Ø—Ä–∫–∏–π –Ω–µ–ø—Ä—è–º–æ–π —Å–≤–µ—Ç",
            "temperature": "18-27¬∞C",
            "soil": "–†—ã—Ö–ª–∞—è, –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ—á–≤–∞ —Å —Ö–æ—Ä–æ—à–∏–º –¥—Ä–µ–Ω–∞–∂–µ–º"
        },
        "—Ñ–∏–∫—É—Å": {
            "name": "–§–∏–∫—É—Å",
            "watering": "–†–∞–∑ –≤ 7-10 –¥–Ω–µ–π, –∫–æ–≥–¥–∞ –≤–µ—Ä—Ö–Ω–∏–π —Å–ª–æ–π –ø–æ—á–≤—ã –ø–æ–¥—Å–æ—Ö–Ω–µ—Ç",
            "light": "–Ø—Ä–∫–∏–π –Ω–µ–ø—Ä—è–º–æ–π —Å–≤–µ—Ç",
            "temperature": "18-24¬∞C",
            "soil": "–õ–µ–≥–∫–∞—è, –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ—á–≤–∞ —Å —Ö–æ—Ä–æ—à–∏–º –¥—Ä–µ–Ω–∞–∂–µ–º"
        },
        "—Å—É–∫–∫—É–ª–µ–Ω—Ç": {
            "name": "–°—É–∫–∫—É–ª–µ–Ω—Ç",
            "watering": "–†–∞–∑ –≤ 2-3 –Ω–µ–¥–µ–ª–∏, –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Å—É—à–∏–≤–∞—è –ø–æ—á–≤—É –º–µ–∂–¥—É –ø–æ–ª–∏–≤–∞–º–∏",
            "light": "–Ø—Ä–∫–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ, –ø—Ä—è–º–æ–π —Å–æ–ª–Ω–µ—á–Ω—ã–π —Å–≤–µ—Ç",
            "temperature": "18-27¬∞C",
            "soil": "–•–æ—Ä–æ—à–æ –¥—Ä–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è, –ø–µ—Å—á–∞–Ω–∞—è –ø–æ—á–≤–∞"
        },
        "—Ö–ª–æ—Ä–æ—Ñ–∏—Ç—É–º": {
            "name": "–•–ª–æ—Ä–æ—Ñ–∏—Ç—É–º",
            "watering": "–†–∞–∑ –≤ 7-10 –¥–Ω–µ–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—è –ø–æ—á–≤—É —Å–ª–µ–≥–∫–∞ –≤–ª–∞–∂–Ω–æ–π",
            "light": "–Ø—Ä–∫–∏–π –Ω–µ–ø—Ä—è–º–æ–π —Å–≤–µ—Ç",
            "temperature": "18-24¬∞C",
            "soil": "–õ–µ–≥–∫–∞—è, —Ö–æ—Ä–æ—à–æ –¥—Ä–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ—á–≤–∞"
        }
    }
    
    # –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è –ø–æ–∏—Å–∫–∞
    plant_name_lower = plant_name.lower()
    
    # –ò—â–µ–º —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤ –Ω–∞—à–µ–π –±–∞–∑–µ
    if plant_name_lower in plants:
        plant = plants[plant_name_lower]
        
        text = f"""üå± *{plant['name']}*

üíß *–ü–æ–ª–∏–≤:* {plant['watering']}

‚òÄÔ∏è *–û—Å–≤–µ—â–µ–Ω–∏–µ:* {plant['light']}

üå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:* {plant['temperature']}

üå± *–ü–æ—á–≤–∞:* {plant['soil']}

üí° *–°–æ–≤–µ—Ç:* –†–µ–≥—É–ª—è—Ä–Ω–æ –æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤—Ä–µ–¥–∏—Ç–µ–ª–µ–π –∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π."""
        
        send_message(chat_id, text, parse_mode="Markdown")
    else:
        # –ï—Å–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
        send_message(chat_id, f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É –º–µ–Ω—è –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å—Ç–µ–Ω–∏–∏ '{plant_name}'. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è.")


def send_message(chat_id, text, parse_mode=None):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Telegram API"""
    url = f"{TELEGRAM_API}/sendMessage"
    
    data = {
        "chat_id": chat_id,
        "text": text
    }
    
    if parse_mode:
        data["parse_mode"] = parse_mode
    
    try:
        response = requests.post(url, json=data)
        return response.json()
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        return None 